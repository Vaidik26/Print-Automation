{% extends "base.html" %}

{% block content %}

<div class="card">
    <h2>Step 3: Map Columns</h2>
    <p class="text-muted">Match your template placeholders to the data columns.</p>
    
    <form action="/generate" method="post" id="mappingForm">
        <div class="mapping-container">
            {% for placeholder in placeholders %}
            <div class="mapping-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                <div>
                    <span class="placeholder-tag">{{ placeholder }}</span>
                </div>
                <div>
                    <select name="mapping_{{ placeholder }}">
                        <option value="">-- Select Column --</option>
                        {% for col in columns %}
                        <option value="{{ col }}" {% if auto_mapping[placeholder] == col %}selected{% endif %}>
                            {{ col }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border-color);">
        
        <h3>Output Filename</h3>
        <div class="form-group">
            <label>Select column for filenames (optional):</label>
            <select name="filename_column">
                <option value="">-- Auto-numbered (document_001.docx) --</option>
                {% for col in columns %}
                <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-secondary" onclick="submitForm('generate')" style="flex: 1;">Generate Documents üöÄ</button>
            <button type="button" class="btn" onclick="submitForm('email')" style="flex: 1;">Proceed to Email üìß</button>
        </div>
    </form>
    
    <div style="margin-top: 1rem; text-align: center;">
        <a href="/upload-data" style="color: var(--text-secondary); text-decoration: none;">‚¨ÖÔ∏è Back to Data Upload</a>
    </div>
</div>


<script>
    function submitForm(action) {
        // Change button to loading state
        const btnGen = document.querySelector('.btn-secondary');
        const btnEmail = document.querySelector('.btn:not(.btn-secondary)');
        const form = document.getElementById('mappingForm');
        
        if (action === 'generate') {
            btnGen.innerHTML = 'Generating... ‚è≥';
            btnGen.disabled = true;
            if (btnEmail) btnEmail.disabled = true;

            // Handle download
            fetch('/generate', {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Generation failed');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_documents.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                // Reset button
                btnGen.innerHTML = 'Generate Documents üöÄ';
                btnGen.disabled = false;
                if (btnEmail) btnEmail.disabled = false;
            })
            .catch(error => {
                alert('Error generating documents: ' + error.message);
                btnGen.innerHTML = 'Generate Documents üöÄ';
                btnGen.disabled = false;
                if (btnEmail) btnEmail.disabled = false;
            });
        } else if (action === 'email') {
            // Save mapping first then redirect
            const formData = new FormData(form);
            fetch('/save-mapping', {
                method: 'POST',
                body: formData
            }).then(() => {
                window.location.href = '/email-config';
            });
        }
    }
</script>
{% endblock %}

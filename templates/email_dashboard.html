{% extends "base.html" %}

{% block content %}

<div class="card">
    <div class="dashboard-header">
        <div>
            <h2>üì® Email Dispatch Dashboard</h2>
            <p class="text-muted">Monitor and control your email campaign</p>
        </div>
        <div style="gap: 1rem; display: flex;">
            <button id="startBtn" class="btn" onclick="startSending()">
                <span>Start Sending</span> ‚ñ∂Ô∏è
            </button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;" onclick="stopSending()">
                <span>Stop</span> ‚èπÔ∏è
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="pendingCount">{{ emails|length }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sentCount">0</div>
            <div class="stat-label">Sent</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="failedCount" style="color: var(--error-text);">0</div>
            <div class="stat-label">Failed</div>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Recipient Email</th>
                    <th>Attachment Name</th>
                    <th style="text-align: center;">Delivery Status</th>
                    <th style="text-align: right;">Controls</th>
                </tr>
            </thead>
            <tbody>
                {% for email in emails %}
                <tr id="row-{{ loop.index0 }}" class="email-row" data-index="{{ loop.index0 }}">
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="font-bold">{{ email.to_email }}</div>
                        <div class="text-muted text-sm">{{ email.subject }}</div>
                    </td>
                    <td>{{ email.attachment_filename }}</td>
                    <td style="text-align: center;">
                        <span class="status-badge status-pending">Pending</span>
                    </td>
                    <td style="text-align: right;">
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="skipEmail({{ loop.index0 }})">Skip ‚è≠Ô∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    let isProcessing = false;
    let shouldStop = false;
    // const totalEmails = {{ emails|length }}; // Unused
    
    // Stats counters - Initialize from DOM just in case, but usually starts at 0 for session
    let sentCount = 0;
    let failedCount = 0;
    
    function updateStatus(index, status, message = "") {
        const row = document.getElementById(`row-${index}`);
        const badge = row.querySelector('.status-badge');
        const actionCell = row.querySelector('td:last-child');
        const skipBtn = row.querySelector('button');
        
        // Reset classes
        badge.className = 'status-badge';
        badge.style = ''; // clear any inline styles
        
        // Add new status class
        badge.classList.add(`status-${status.toLowerCase()}`);
        
        if (status === 'Sending') {
            badge.textContent = 'Sending...';
            if (skipBtn) {
                skipBtn.disabled = true;
                skipBtn.style.opacity = '0.5';
                skipBtn.style.cursor = 'not-allowed';
            }
        } else if (status === 'Sent') {
            badge.textContent = '‚úÖ Sent';
            actionCell.innerHTML = ''; // Remove actions
            
            // Increment logic moved to main loop to avoid double counting if termed 'updateStatus' multiple times
        } else if (status === 'Failed') {
            badge.textContent = '‚ùå Failed';
            actionCell.innerHTML = `<small style="color: var(--error-text);">${message}</small>`;
        } else if (status === 'Skipped') {
            badge.textContent = '‚è≠Ô∏è Skipped';
            actionCell.innerHTML = '';
        }
    }

    async function startSending() {
        if (isProcessing) return;
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        try {
            isProcessing = true;
            shouldStop = false;
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-flex';
            stopBtn.innerHTML = '<span>Stop</span> ‚èπÔ∏è';
            
            const rows = document.querySelectorAll('.email-row');
            let processedAny = false;
            
            for (let i = 0; i < rows.length; i++) {
                if (shouldStop) break;
                
                const row = rows[i];
                const index = row.dataset.index;
                const badge = row.querySelector('.status-badge');
                
                // 1. Initial Check: Only process pending items
                if (!badge.textContent.includes('Pending')) continue;
                
                // 2. Scroll into view and highlight as "Preparing"
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 3. Grace Period Delay (Allow user to skip THIS item before it sends)
                // We leave it as 'Pending' visually or could change color slightly, 
                // but keeping it 'Pending' allows valid skipping via our existing logic.
                await new Promise(r => setTimeout(r, 1500));

                // 4. Re-Check: Did user click Stop or Skip during the delay?
                if (shouldStop) break;
                if (!badge.textContent.includes('Pending')) continue;
                
                // NOW we commit to sending
                processedAny = true;
                updateStatus(index, 'Sending');
                
                try {
                    const response = await fetch(`/send-single/${index}`, {
                        method: 'POST'
                    });
                    
                    if (response.status === 403) {
                        throw new Error("Session expired. Please refresh the page.");
                    }

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        updateStatus(index, 'Sent');
                        sentCount++;
                        document.getElementById('sentCount').textContent = sentCount;
                    } else {
                        updateStatus(index, 'Failed', result.message || "Unknown error");
                        failedCount++;
                        document.getElementById('failedCount').textContent = failedCount;
                    }
                } catch (error) {
                    console.error("Sending error:", error);
                    updateStatus(index, 'Failed', error.message);
                    failedCount++;
                    document.getElementById('failedCount').textContent = failedCount;
                }
                
                // Update pending count
                updateCounts();
            }
            
            if (!shouldStop && !processedAny) {
                 updateCounts();
                 const pending = parseInt(document.getElementById('pendingCount').textContent || '0');
                 if (pending === 0) alert('All emails have been processed!');
            } else if (!shouldStop) {
                 updateCounts();
                 const pending = parseInt(document.getElementById('pendingCount').textContent || '0');
                 if (pending === 0) alert('Batch processing completed!');
            }

        } catch (e) {
            console.error("Critical Dashboard Error:", e);
            alert("An error occurred: " + e.message);
        } finally {
            isProcessing = false;
            startBtn.style.display = 'inline-flex';
            stopBtn.style.display = 'none';
            startBtn.innerHTML = '<span>Continue Sending</span> ‚ñ∂Ô∏è';
        }
    }

    function stopSending() {
        shouldStop = true;
        document.getElementById('stopBtn').innerHTML = '<span>Stopping...</span>';
    }

    async function skipEmail(index) {
        const row = document.getElementById(`row-${index}`);
        const badge = row.querySelector('.status-badge');
        
        if (badge.textContent.includes('Sending')) {
            return;
        }
        
        // Optimistic UI update
        updateStatus(index, 'Skipped');
        updateCounts();
        
        try {
            await fetch(`/skip-single/${index}`, { method: 'POST' });
        } catch (e) {
            console.error(e);
        }
    }

    function updateCounts() {
        const pending = document.querySelectorAll('.email-row .status-badge');
        let count = 0;
        pending.forEach(b => {
             if (b.textContent.includes('Pending')) count++;
        });
        document.getElementById('pendingCount').textContent = count;
    }
</script>
{% endblock %}
